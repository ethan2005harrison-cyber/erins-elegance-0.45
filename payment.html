<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment ‚Äî erin‚Äôs elegance</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/4150/4150897.png" type="image/png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Open+Sans:wght@300;400;600&display=swap');
    :root{ --vogue:#565D4F; --champagne:#E6D5B8; --cream:#F7F3EA; --charcoal:#2C2C2C; --line:rgba(230,213,184,.35); }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:'Open Sans',sans-serif; background:var(--vogue); color:var(--cream); overflow-x:hidden; position:relative; }
    header{ background:rgba(247,243,234,.08); backdrop-filter:blur(10px); position:fixed; width:100%; top:0; z-index:20; }
    .header-container{ max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding:1.1rem 2rem; }
    .logo{ font-family:'Playfair Display',serif; font-size:1.6rem; color:var(--cream); font-weight:600; letter-spacing:.3px; }
    .menu{ position:relative; }
    .menu-btn{ background:rgba(230,213,184,.15); color:var(--cream); border:1px solid rgba(230,213,184,.35); border-radius:999px; padding:.6rem 1rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:.6rem; transition:background .25s,border-color .25s,transform .15s; }
    .menu-btn:hover{ background:rgba(230,213,184,.22); transform:translateY(-1px) }
    .menu-btn:focus{ outline:2px solid rgba(230,213,184,.6); outline-offset:2px }
    .menu-btn svg{ width:18px;height:18px }
    .menu-panel{ position:absolute; right:0; top:calc(100% + .6rem); background:rgba(22,24,21,.72); backdrop-filter:blur(10px); border:1px solid rgba(230,213,184,.28); border-radius:16px; min-width:220px; padding:.6rem; box-shadow:0 12px 28px rgba(0,0,0,.28); opacity:0; transform:translateY(-6px); pointer-events:none; transition:opacity .2s, transform .2s; }
    .menu-panel.open{ opacity:1; transform:translateY(0); pointer-events:auto }
    .menu-panel a{ display:block; padding:.75rem .9rem; border-radius:12px; text-decoration:none; color:var(--cream); font-weight:600; border:1px solid transparent; }
    .menu-panel a:hover{ background:rgba(230,213,184,.12); border-color:rgba(230,213,184,.22) }
    .bg-stage{ position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
    .bg-tint{ position:absolute; inset:0; filter:saturate(103%); background:
      radial-gradient(1100px 760px at 18% 22%, rgba(98,106,91,0.36) 0%, transparent 60%),
      radial-gradient(1000px 700px at 82% 78%, rgba(75,82,70,0.42) 0%, transparent 55%),
      var(--vogue); }
    .petals,.petals::before,.petals::after{ position:absolute; inset:-15%; content:""; background:
      radial-gradient(28% 22% at 20% 30%, rgba(230,213,184,0.12) 0%, rgba(230,213,184,0) 60%),
      radial-gradient(22% 18% at 70% 65%, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0) 60%),
      radial-gradient(18% 14% at 55% 35%, rgba(230,213,184,0.09) 0%, rgba(230,213,184,0) 60%),
      radial-gradient(16% 12% at 35% 78%, rgba(230,213,184,0.07) 0%, rgba(230,213,184,0) 60%); filter:blur(8px); opacity:.5; animation:petalsFloat 46s ease-in-out infinite; }
    .petals::before{ transform:scale(1.08); opacity:.44; animation:petalsFloatReverse 60s ease-in-out infinite }
    .petals::after{ transform:scale(1.16); opacity:.38; animation:petalsFloat 74s ease-in-out infinite }
    @keyframes petalsFloat{ 0%{transform:translate3d(0,0,0)} 50%{transform:translate3d(-2%,1.2%,0)} 100%{transform:translate3d(0,0,0)} }
    @keyframes petalsFloatReverse{ 0%{transform:translate3d(0,0,0)} 50%{transform:translate3d(2%,-1.2%,0)} 100%{transform:translate3d(0,0,0)} }
    @keyframes fadeUp{ to{opacity:1; transform:translateY(0)} }
    main{ max-width:640px; margin:12rem auto 4rem; padding:0 2rem; text-align:center; position:relative; z-index:2; }
    h1{ font-family:'Playfair Display',serif; font-size:2.5rem; margin-bottom:1rem; opacity:0; transform:translateY(-20px); animation:fadeUp 1s forwards; animation-delay:.5s; }
    p{ font-size:1.1rem; margin-bottom:2rem; color:var(--cream); opacity:0; transform:translateY(-20px); animation:fadeUp 1s forwards; animation-delay:1s; }
    .summary{ background:rgba(247,243,234,0.08); border:1px solid var(--line); border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.1); padding:1.5rem; margin-bottom:2rem; text-align:left; opacity:0; transform:translateY(-20px); animation:fadeUp 1s forwards; animation-delay:1.2s; }
    .summary h3{ font-family:'Playfair Display',serif; margin-top:0; color:var(--cream) }
    .summary ul{ list-style:none; padding:0; margin:.5rem 0 1rem }
    .summary ul li{ padding:.3rem 0; border-bottom:1px solid rgba(230,213,184,.12); font-size:1rem }
    .summary .total{ font-weight:600; margin-top:1rem; text-align:right; font-family:'Playfair Display',serif }
    .payment-options{ display:flex; flex-direction:column; gap:1rem; opacity:0; transform:translateY(-20px); animation:fadeUp 1s forwards; animation-delay:1.6s; }
    .payment-option{ display:flex; align-items:center; justify-content:space-between; background:rgba(247,243,234,0.08); border-radius:12px; padding:1rem 1.2rem; border:1px solid var(--line); transition:border-color .3s, background .3s; }
    .payment-option.active{ border-color:var(--champagne); background:rgba(247,243,234,0.12) }
    .payment-option.disabled{ opacity:.5; cursor:not-allowed }
    .payment-option.disabled::after{ content:"Currently Unavailable"; font-size:.9rem; color:var(--champagne); font-weight:600; margin-left:10px }
    button{ background-color:var(--champagne); color:var(--charcoal); border:none; padding:1rem 2.5rem; border-radius:50px; font-size:1rem; cursor:pointer; margin-top:2rem; transition:background-color .3s, box-shadow .3s; opacity:0; transform:translateY(-20px); animation:fadeUp 1s forwards; animation-delay:2s; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,.18) }
    button:hover{ background-color:#e0cba4; box-shadow:0 10px 24px rgba(0,0,0,.22) }
    .address{ margin-top:2.5rem; font-size:.95rem; color:var(--cream); opacity:.9; font-family:'Open Sans',sans-serif }
    .small{ font-size:.92rem; opacity:.9; margin-top:.6rem }
    footer{ text-align:center; padding:2rem; font-size:.9rem; color:var(--cream); opacity:.9 }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo">erin‚Äôs elegance</div>
      <div class="menu">
        <button class="menu-btn" id="menuButton" aria-haspopup="true" aria-expanded="false" aria-controls="primaryMenu">
          <span>Menu</span>
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z"/></svg>
        </button>
        <nav id="primaryMenu" class="menu-panel" aria-label="Primary">
          <a href="index.html">Home</a>
          <a href="services.html">Services</a>
          <a href="booking.html">Booking</a>
          <a href="about.html">About Our Service</a>
          <a href="terms.html">Terms & Conditions</a>
        </nav>
      </div>
    </div>
  </header>

  <div class="bg-stage" aria-hidden="true">
    <div class="bg-tint"></div>
    <div class="petals"></div>
  </div>

  <main>
    <h1>Review & Payment</h1>
    <p>Please review your booking details and choose your payment option below.</p>

    <div class="summary" id="summaryBox">
      <h3>Your Selected Services:</h3>
      <ul id="serviceList"></ul>
      <div class="total" id="totalCost">Total: ¬£0.00</div>
    </div>

    <div class="payment-options">
      <div class="payment-option active" id="payInPerson">
        <span>üí≥ Pay in person</span>
        <small>Please bring a method of payment with you.</small>
      </div>
      <div class="payment-option disabled">
        <span>üÖøÔ∏è Pay with PayPal</span>
      </div>
    </div>

    <button id="confirmBtn">Confirm Booking</button>

    <div class="address">
      <p><strong>Address:</strong> 16 Werrington Drive, Callington, Cornwall, PL17 7TF</p>
      <p class="small">We don‚Äôt share your details with anyone. Your information is used only to arrange and confirm your appointment.</p>
    </div>
  </main>

  <footer>
    <p>¬© 2025 erin‚Äôs elegance. all rights reserved.</p>
  </footer>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0AI5Ow3gzvCNq9qju1oIx35LdFKN-5NoIevOIRMVHcQVDIgf62huPMTw199ZVPqY2/exec";
    const FORMSPREE_URL = "https://formspree.io/f/xdkwjqyl";

    (function(){
      const btn=document.getElementById('menuButton'), panel=document.getElementById('primaryMenu');
      if(!btn||!panel) return;
      const close=()=>{panel.classList.remove('open'); btn.setAttribute('aria-expanded','false');};
      const open =()=>{panel.classList.add('open'); btn.setAttribute('aria-expanded','true');};
      btn.addEventListener('click',e=>{e.stopPropagation(); (btn.getAttribute('aria-expanded')==='true')?close():open();});
      document.addEventListener('click',e=>{ if(!panel.contains(e.target)&&!btn.contains(e.target)) close(); });
      document.addEventListener('keydown',e=>{ if(e.key==='Escape') close(); });
    })();

    const params = new URLSearchParams(window.location.search);
    const serviceListEl = document.getElementById("serviceList");
    const totalCostEl = document.getElementById("totalCost");

    let services = params.getAll("service");
    if (services.length === 0) {
      const s = params.get("services");
      if (s) services = s.split(",").map(v => v.trim()).filter(Boolean);
    }

    let total = 0; serviceListEl.innerHTML = "";
    services.forEach(s => {
      let name = s, priceNum = 0;
      if (s.includes("-")) {
        const parts = s.split("-");
        name = parts[0].trim();
        const raw = (parts[1] || "").replace(/[¬£,\s]/g,"");
        priceNum = parseFloat(raw) || 0;
      }
      const li = document.createElement("li");
      li.textContent = `${name} ‚Äî ¬£${priceNum.toFixed(2)}`;
      serviceListEl.appendChild(li);
      total += priceNum;
    });
    totalCostEl.textContent = `Total: ¬£${total.toFixed(2)}`;

    const payload = {
      name: params.get("name") || "",
      email: params.get("email") || "",
      phone: params.get("phone") || "",
      date: params.get("desiredDate") || params.get("date") || "",
      time: params.get("desiredTime") || params.get("time") || "",
      services: services.join("; "),
      notes: params.get("notes") || ""
    };

    async function isStillAvailable(dateStr, timeStr){
      const res = await fetch(`${SCRIPT_URL}?date=${encodeURIComponent(dateStr)}`);
      if(!res.ok) return true; // fail-open
      const data = await res.json();
      const list = Array.isArray(data.booked) ? data.booked : [];
      return !list.includes(timeStr);
    }

    // POST to Apps Script as x-www-form-urlencoded (no headers ‚Üí no preflight)
    async function postBookingToSheetForm(payload){
      const form = new URLSearchParams();
      form.append('name', payload.name);
      form.append('email', payload.email);
      form.append('phone', payload.phone);
      form.append('date', payload.date);
      form.append('time', payload.time);
      form.append('services', payload.services);
      form.append('notes', payload.notes);

      const res = await fetch(SCRIPT_URL, { method: "POST", body: form }); // no headers
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      // We don't need the response body; success status is enough
      return true;
    }

    async function notifyFormspree(payload, total){
      const body = {
        _subject: "New Booking ‚Äî Erin‚Äôs Elegance",
        Name: payload.name, Email: payload.email, Phone: payload.phone,
        Date: payload.date, Time: payload.time,
        Services: payload.services, Notes: payload.notes,
        Total: `¬£${Number(total).toFixed(2)}`,
        PaymentMethod: "Pay in person (on the day)"
      };
      try{
        await fetch(FORMSPREE_URL, {
          method: "POST",
          headers: { "Accept": "application/json", "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
      }catch(err){ console.warn("Formspree notify failed:", err); }
    }

    const confirmBtn = document.getElementById("confirmBtn");
    confirmBtn.addEventListener("click", async () => {
      confirmBtn.disabled = true; const old = confirmBtn.textContent; confirmBtn.textContent = "Confirming‚Ä¶";
      try {
        if(!payload.date || !payload.time) throw new Error("Missing date or time. Please go back and pick both.");
        if(services.length === 0) throw new Error("No services selected. Please go back and choose at least one service.");

        const okAvail = await isStillAvailable(payload.date, payload.time);
        if(!okAvail){
          alert("Sorry ‚Äî that time has just been taken. Please pick another time.");
          window.location.href = `booking.html?date=${encodeURIComponent(payload.date)}`;
          return;
        }

        await postBookingToSheetForm(payload); // Simple form POST ‚Äî no CORS preflight
        await notifyFormspree(payload, total); // Email notify (non-blocking)

        window.location.href = "thankspage.html";
      } catch (e) {
        console.error(e);
        alert("We couldn‚Äôt confirm your booking right now.\n\n" + (e?.message || "Please try again."));
        confirmBtn.disabled = false; confirmBtn.textContent = old;
      }
    });
  </script>
</body>
</html>
